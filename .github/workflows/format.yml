name: Code Formatting

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install formatting tools
      run: |
        pip install black isort

    - name: Check Black formatting
      id: black_check
      continue-on-error: true
      run: |
        echo "Running Black formatter check..."
        if ! black --check --diff .; then
          echo "format_issues=true" >> $GITHUB_OUTPUT
          echo "::warning::Code is not formatted with Black. Run 'black .' locally to fix."
          exit 0
        else
          echo "format_issues=false" >> $GITHUB_OUTPUT
          echo "âœ… All files are properly formatted with Black"
        fi

    - name: Check isort imports
      id: isort_check
      continue-on-error: true
      run: |
        echo "Running isort import check..."
        if ! isort --check-only --diff .; then
          echo "import_issues=true" >> $GITHUB_OUTPUT
          echo "::warning::Imports are not sorted with isort. Run 'isort .' locally to fix."
          exit 0
        else
          echo "import_issues=false" >> $GITHUB_OUTPUT
          echo "âœ… All imports are properly sorted with isort"
        fi

    - name: Comment on PR with formatting instructions
      if: |
        (steps.black_check.outputs.format_issues == 'true' || 
         steps.isort_check.outputs.import_issues == 'true') && 
        github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const blackIssues = '${{ steps.black_check.outputs.format_issues }}' === 'true';
          const isortIssues = '${{ steps.isort_check.outputs.import_issues }}' === 'true';
          
          let body = 'âš ï¸ **Code Formatting Issues Detected**\n\n';
          body += 'Some files need formatting adjustments:\n\n';
          
          if (blackIssues) {
            body += '- âŒ **Black**: Code is not properly formatted\n';
          }
          if (isortIssues) {
            body += '- âŒ **isort**: Imports are not properly sorted\n';
          }
          
          body += '\n### ðŸ”§ How to Fix\n\n';
          body += 'Run these commands locally to auto-format your code:\n\n';
          body += '```bash\n';
          body += '# Install formatting tools (if not already installed)\n';
          body += 'pip install black isort\n\n';
          
          if (blackIssues && isortIssues) {
            body += '# Format code and sort imports\n';
            body += 'black .\n';
            body += 'isort .\n';
          } else if (blackIssues) {
            body += '# Format code\n';
            body += 'black .\n';
          } else if (isortIssues) {
            body += '# Sort imports\n';
            body += 'isort .\n';
          }
          
          body += '```\n\n';
          body += 'Then commit and push the changes:\n\n';
          body += '```bash\n';
          body += 'git add .\n';
          body += 'git commit -m "style: apply code formatting"\n';
          body += 'git push\n';
          body += '```\n\n';
          body += '### ðŸ“ Configuration\n\n';
          body += '**Black**: Uses default settings (88 character line length)\n';
          body += '**isort**: Compatible with Black formatting\n\n';
          body += '---\n';
          body += '*Note: This is a warning only and will not block your PR from merging.*';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Summary
      run: |
        echo "### Code Formatting Check Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.black_check.outputs.format_issues }}" = "true" ] || [ "${{ steps.isort_check.outputs.import_issues }}" = "true" ]; then
          echo "âš ï¸ **Formatting issues detected (warnings only)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.black_check.outputs.format_issues }}" = "true" ]; then
            echo "- Black: âŒ Needs formatting" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Black: âœ… Properly formatted" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.isort_check.outputs.import_issues }}" = "true" ]; then
            echo "- isort: âŒ Imports need sorting" >> $GITHUB_STEP_SUMMARY
          else
            echo "- isort: âœ… Imports properly sorted" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To fix:** Run \`black . && isort .\` locally" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **All formatting checks passed!**" >> $GITHUB_STEP_SUMMARY
        fi
