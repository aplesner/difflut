name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort

    - name: Run black
      run: |
        black --check difflut/ tests/ --line-length=100

    - name: Run flake8
      run: |
        flake8 difflut/ tests/ --max-line-length=100 --count

    - name: Run isort
      run: |
        isort --check-only difflut/ tests/

  version-bump-reminder:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if version bump needed
      run: |
        # Get current version from main branch
        if git rev-parse origin/main >/dev/null 2>&1; then
          MAIN_VERSION=$(git show origin/main:pyproject.toml 2>/dev/null | grep "version = " | head -1 | sed 's/.*version = "//;s/".*//')
          PR_VERSION=$(grep "version = " pyproject.toml | head -1 | sed 's/.*version = "//;s/".*//')
          
          if [ -z "$MAIN_VERSION" ]; then
            echo "⚠️  Could not get version from main branch"
          elif [ "$MAIN_VERSION" = "$PR_VERSION" ]; then
            echo "⚠️  Version not bumped in this PR"
            echo ""
            echo "If this PR introduces changes that should be released, please bump the version:"
            echo ""
            echo "  bump2version patch    # Bug fixes (1.1.2 → 1.1.3)"
            echo "  bump2version minor    # New features (1.1.2 → 1.2.0)"
            echo "  bump2version major    # Breaking changes (1.1.2 → 2.0.0)"
            echo ""
            echo "Then commit the changes and push to your PR."
          else
            echo "✅ Version bumped: $MAIN_VERSION → $PR_VERSION"
          fi
        fi

  documentation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install sphinx
      run: |
        pip install sphinx sphinx-rtd-theme

    - name: Build docs
      run: |
        cd docs
        make html 2>&1 | tee build.log
        
        # Check for warnings
        if grep -i "warning" build.log; then
          echo "⚠️  Documentation build completed with warnings"
        else
          echo "✅ Documentation built successfully"
        fi
      continue-on-error: true
