name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort

    - name: Run black
      run: |
        black --check difflut/ tests/ --line-length=100

    - name: Run flake8
      run: |
        flake8 difflut/ tests/ --max-line-length=100 --count

    - name: Run isort
      run: |
        isort --check-only difflut/ tests/

  validate-version:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Validate version consistency
      run: |
        # Extract versions from each file
        SETUP_VERSION=$(grep "version=" setup.py | head -1 | sed "s/.*version='//;s/'.*//")
        PYPROJECT_VERSION=$(grep "version = " pyproject.toml | head -1 | sed 's/.*version = "//;s/".*//')
        INIT_VERSION=$(grep "__version__ = " difflut/__init__.py | head -1 | sed "s/.*__version__ = '//;s/'.*//")
        
        echo "setup.py version: $SETUP_VERSION"
        echo "pyproject.toml version: $PYPROJECT_VERSION"
        echo "difflut/__init__.py version: $INIT_VERSION"
        
        # Check if versions match
        if [ "$SETUP_VERSION" != "$PYPROJECT_VERSION" ] || [ "$SETUP_VERSION" != "$INIT_VERSION" ]; then
          echo "❌ Version mismatch detected!"
          exit 1
        fi
        
        echo "✅ All versions are consistent: $SETUP_VERSION"

  documentation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install sphinx
      run: |
        pip install sphinx sphinx-rtd-theme

    - name: Build docs
      run: |
        cd docs
        make html 2>&1 | tee build.log
        
        # Check for warnings
        if grep -i "warning" build.log; then
          echo "⚠️  Documentation build completed with warnings"
        else
          echo "✅ Documentation built successfully"
        fi
      continue-on-error: true
