name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Python 3.10+ required for PEP 604 union type syntax (X | Y)
          - python-version: '3.10'
            torch-version: 'torch==2.4.0'
          - python-version: '3.10'
            torch-version: 'torch==2.5.0'
          - python-version: '3.11'
            torch-version: 'torch==2.6.0'
          - python-version: '3.11'
            torch-version: 'torch==2.7.0'
          - python-version: '3.12'
            torch-version: 'torch==2.8.0'
          - python-version: '3.12'
            torch-version: 'torch==2.9.0'

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
        docker rmi $(docker images -q) || true
        sudo apt-get clean

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev

    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip setuptools wheel

    - name: Install PyTorch (CPU)
      run: |
        pip install ${{ matrix.torch-version }} torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

    - name: Install DiffLUT (CPU-only)
      run: |
        pip install -e .[cpu,dev]

    - name: GPU Testing Warning
      id: gpu_warning
      run: |
        echo "needs_gpu_testing=true" >> $GITHUB_OUTPUT
        echo ""
        echo "⚠️  ============================================================"
        echo "⚠️  GPU TESTING NOT AVAILABLE IN CI"
        echo "⚠️  ============================================================"
        echo "⚠️  GitHub Actions runners do NOT have NVIDIA GPU hardware."
        echo "⚠️  Tests will run using CPU implementations only."
        echo "⚠️  "
        echo "⚠️  GPU-marked tests (@pytest.mark.gpu) will FAIL as expected."
        echo "⚠️  These tests require actual CUDA hardware to pass."
        echo "⚠️  "
        echo "⚠️  TO RUN GPU TESTS LOCALLY:"
        echo "⚠️    cd difflut && ./tests/test_gpu.sh --fast"
        echo "⚠️  "
        echo "⚠️  Self-hosted GPU runners are in progress..."
        echo "⚠️  ============================================================"
        echo ""

    - name: Run fast tests (CPU only - exclude GPU tests)
      run: |
        python -m pytest tests/ -v -m "not slow and not gpu and not skip_ci and not experimental" --tb=short

    - name: Run all tests with coverage (CPU only - exclude GPU tests)
      run: |
        python -m pytest tests/ -v -m "not gpu and not skip_ci and not experimental" --tb=short --cov=difflut --cov-report=xml --cov-report=html

    - name: Upload coverage reports
      if: always()
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: cpu-py${{ matrix.python-version }}
        name: cpu-py${{ matrix.python-version }}
        fail_ci_if_error: false

    - name: Comment on PR about GPU testing (only on pull requests)
      if: steps.gpu_warning.outputs.needs_gpu_testing == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '⚠️ **GPU Testing Required**\n\n' +
                  'GitHub Actions CI does **not** have NVIDIA GPU hardware.\n' +
                  'Tests marked with `@pytest.mark.gpu` are **excluded** from CI runs.\n\n' +
                  '### To run GPU tests locally:\n' +
                  '```bash\n' +
                  'cd difflut\n' +
                  './tests/test_gpu.sh --fast   # Quick GPU validation\n' +
                  './tests/test_gpu.sh --all    # Full GPU test suite\n' +
                  '```\n\n' +
                  '### GPU tests verify:\n' +
                  '- ✅ CUDA kernel compilation and loading\n' +
                  '- ✅ CPU/GPU output consistency\n' +
                  '- ✅ Fused kernel correctness\n' +
                  '- ✅ Gradient flow through CUDA kernels\n\n' +
                  '**Status:** Self-hosted GPU runners are in progress. For now, please test GPU functionality locally before merging.\n\n' +
                  '**Current CI coverage:** CPU implementations only (`-m "not gpu"`)'
          })
      continue-on-error: true
